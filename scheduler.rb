require 'net/http'
require 'nokogiri'
require 'uri'
require 'line/bot'
require 'redis'
require 'json'
require 'dotenv/load'

LINES = {
"函館本線" => "https://transit.yahoo.co.jp/diainfo/9/436",
"千歳線" => "https://transit.yahoo.co.jp/diainfo/11/0",
"学園都市線" => "https://transit.yahoo.co.jp/diainfo/12/0",
"宗谷本線" => "https://transit.yahoo.co.jp/diainfo/423/0",
"石北本線" => "https://transit.yahoo.co.jp/diainfo/424/0",
"釧網本線" => "https://transit.yahoo.co.jp/diainfo/425/0",
"留萌本線" => "https://transit.yahoo.co.jp/diainfo/426/0",
"根室本線" => "https://transit.yahoo.co.jp/diainfo/428/0",
"富良野線" => "https://transit.yahoo.co.jp/diainfo/429/0",
"石勝線" => "https://transit.yahoo.co.jp/diainfo/430/0",
"日高本線" => "https://transit.yahoo.co.jp/diainfo/431/0",
"室蘭本線" => "https://transit.yahoo.co.jp/diainfo/432/433",
"花咲線" => "https://transit.yahoo.co.jp/diainfo/439/0",
"札幌市営東西線" => "https://transit.yahoo.co.jp/diainfo/13/0",
"札幌市営南北線" => "https://transit.yahoo.co.jp/diainfo/14/0",
"札幌市営東豊線" => "https://transit.yahoo.co.jp/diainfo/15/0",
"道南いさりび鉄道線" => "https://transit.yahoo.co.jp/diainfo/638/0",
"東北本線" => "https://transit.yahoo.co.jp/diainfo/16/441",
"仙山線" => "https://transit.yahoo.co.jp/diainfo/18/0",
"仙石線" => "https://transit.yahoo.co.jp/diainfo/19/0",
"常磐線" => "https://transit.yahoo.co.jp/diainfo/59/60",
"磐越東線" => "https://transit.yahoo.co.jp/diainfo/444/0",
"磐越西線" => "https://transit.yahoo.co.jp/diainfo/445/0",
"只見線" => "https://transit.yahoo.co.jp/diainfo/446/0",
"石巻線" => "https://transit.yahoo.co.jp/diainfo/447/0",
"気仙沼線" => "https://transit.yahoo.co.jp/diainfo/448/0",
"大船渡線" => "https://transit.yahoo.co.jp/diainfo/449/0",
"釜石線" => "https://transit.yahoo.co.jp/diainfo/450/0",
"山田線" => "https://transit.yahoo.co.jp/diainfo/451/0",
"八戸線" => "https://transit.yahoo.co.jp/diainfo/453/0",
"大湊線" => "https://transit.yahoo.co.jp/diainfo/454/0",
"山形線" => "https://transit.yahoo.co.jp/diainfo/455/0",
"奥羽本線" => "https://transit.yahoo.co.jp/diainfo/456/457",
"米坂線" => "https://transit.yahoo.co.jp/diainfo/458/0",
"左沢線" => "https://transit.yahoo.co.jp/diainfo/459/0",
"陸羽東線" => "https://transit.yahoo.co.jp/diainfo/460/0",
"陸羽西線" => "https://transit.yahoo.co.jp/diainfo/461/0",
"北上線" => "https://transit.yahoo.co.jp/diainfo/462/0",
"田沢湖線" => "https://transit.yahoo.co.jp/diainfo/463/0",
"花輪線" => "https://transit.yahoo.co.jp/diainfo/464/0",
"男鹿線" => "https://transit.yahoo.co.jp/diainfo/465/0",
"五能線" => "https://transit.yahoo.co.jp/diainfo/466/0",
"津軽線" => "https://transit.yahoo.co.jp/diainfo/467/0",
"羽越本線" => "https://transit.yahoo.co.jp/diainfo/468/626",
"白新線" => "https://transit.yahoo.co.jp/diainfo/469/0",
"仙台市営南北線" => "https://transit.yahoo.co.jp/diainfo/20/0",
"仙台市営東西線" => "https://transit.yahoo.co.jp/diainfo/636/0",
"弘南鉄道弘南線" => "https://transit.yahoo.co.jp/diainfo/558/0",
"弘南鉄道大鰐線" => "https://transit.yahoo.co.jp/diainfo/559/0",
"会津鉄道線" => "https://transit.yahoo.co.jp/diainfo/183/0",
"仙台空港アクセス線" => "https://transit.yahoo.co.jp/diainfo/542/0",
"阿武隈急行線" => "https://transit.yahoo.co.jp/diainfo/549/0",
"福島交通飯坂線" => "https://transit.yahoo.co.jp/diainfo/550/0",
"山形鉄道フラワー長井線" => "https://transit.yahoo.co.jp/diainfo/551/0",
"三陸鉄道リアス線" => "https://transit.yahoo.co.jp/diainfo/552/0",
"いわて銀河鉄道線" => "https://transit.yahoo.co.jp/diainfo/554/0",
"由利高原鉄道線" => "https://transit.yahoo.co.jp/diainfo/555/0",
"秋田内陸線" => "https://transit.yahoo.co.jp/diainfo/556/0",
"青い森鉄道線" => "https://transit.yahoo.co.jp/diainfo/557/0",
"津軽鉄道線" => "https://transit.yahoo.co.jp/diainfo/560/0",
"山手線" => "https://transit.yahoo.co.jp/diainfo/21/0",
"東海道本線" => "https://transit.yahoo.co.jp/diainfo/192/193",
"中央総武線" => "https://transit.yahoo.co.jp/diainfo/40/0",
"小田急小田原線" => "https://transit.yahoo.co.jp/diainfo/109/0",
"京王線" => "https://transit.yahoo.co.jp/diainfo/102/0",
"京浜東北根岸線" => "https://transit.yahoo.co.jp/diainfo/22/0",
"横須賀線" => "https://transit.yahoo.co.jp/diainfo/29/0",
"横浜線" => "https://transit.yahoo.co.jp/diainfo/31/0",
"相模線" => "https://transit.yahoo.co.jp/diainfo/33/0",
"南武線" => "https://transit.yahoo.co.jp/diainfo/37/0",
"鶴見線" => "https://transit.yahoo.co.jp/diainfo/36/0",
"中央線" => "https://transit.yahoo.co.jp/diainfo/38/0",
"中央本線" => "https://transit.yahoo.co.jp/diainfo/470/0",
"青梅線" => "https://transit.yahoo.co.jp/diainfo/43/44",
"五日市線" => "https://transit.yahoo.co.jp/diainfo/45/0",
"宇都宮線" => "https://transit.yahoo.co.jp/diainfo/46/47",
"高崎線" => "https://transit.yahoo.co.jp/diainfo/48/0",
"埼京川越線" => "https://transit.yahoo.co.jp/diainfo/50/0",
"八高川越線" => "https://transit.yahoo.co.jp/diainfo/52/0",
"八高線" => "https://transit.yahoo.co.jp/diainfo/54/0",
"日光線" => "https://transit.yahoo.co.jp/diainfo/55/0",
"烏山線" => "https://transit.yahoo.co.jp/diainfo/56/0",
"総武線" => "https://transit.yahoo.co.jp/diainfo/61/0",
"総武本線" => "https://transit.yahoo.co.jp/diainfo/62/0",
"内房線" => "https://transit.yahoo.co.jp/diainfo/63/0",
"外房線" => "https://transit.yahoo.co.jp/diainfo/65/0",
"成田線" => "https://transit.yahoo.co.jp/diainfo/68/0",
"京葉線" => "https://transit.yahoo.co.jp/diainfo/69/0",
"武蔵野線" => "https://transit.yahoo.co.jp/diainfo/71/0",
"東金線" => "https://transit.yahoo.co.jp/diainfo/74/0",
"久留里線" => "https://transit.yahoo.co.jp/diainfo/75/0",
"鹿島線" => "https://transit.yahoo.co.jp/diainfo/76/0",
"吾妻線" => "https://transit.yahoo.co.jp/diainfo/162/0",
"伊東線" => "https://transit.yahoo.co.jp/diainfo/163/0",
"上越線" => "https://transit.yahoo.co.jp/diainfo/479/0",
"信越本線" => "https://transit.yahoo.co.jp/diainfo/474/0",
"水郡線" => "https://transit.yahoo.co.jp/diainfo/166/0",
"水戸線" => "https://transit.yahoo.co.jp/diainfo/167/0",
"両毛線" => "https://transit.yahoo.co.jp/diainfo/168/0",
"東武亀戸線" => "https://transit.yahoo.co.jp/diainfo/78/0",
"東武大師線" => "https://transit.yahoo.co.jp/diainfo/79/0",
"東武日光線" => "https://transit.yahoo.co.jp/diainfo/80/0",
"東武東上線" => "https://transit.yahoo.co.jp/diainfo/82/0",
"東武越生線" => "https://transit.yahoo.co.jp/diainfo/83/0",
"東武宇都宮線" => "https://transit.yahoo.co.jp/diainfo/169/0",
"東武鬼怒川線" => "https://transit.yahoo.co.jp/diainfo/170/0",
"東武小泉線" => "https://transit.yahoo.co.jp/diainfo/171/0",
"東武佐野線" => "https://transit.yahoo.co.jp/diainfo/172/0",
"東武桐生線" => "https://transit.yahoo.co.jp/diainfo/173/0",
"東武伊勢崎線" => "https://transit.yahoo.co.jp/diainfo/639/0",
"西武池袋線・秩父線" => "https://transit.yahoo.co.jp/diainfo/84/0",
"西武新宿線" => "https://transit.yahoo.co.jp/diainfo/86/0",
"西武西武園線" => "https://transit.yahoo.co.jp/diainfo/87/0",
"西武国分寺線" => "https://transit.yahoo.co.jp/diainfo/88/0",
"西武多摩湖線" => "https://transit.yahoo.co.jp/diainfo/89/0",
"西武有楽町線" => "https://transit.yahoo.co.jp/diainfo/90/0",
"西武豊島線" => "https://transit.yahoo.co.jp/diainfo/91/0",
"西武狭山線" => "https://transit.yahoo.co.jp/diainfo/92/0",
"西武拝島線" => "https://transit.yahoo.co.jp/diainfo/93/0",
"西武多摩川線" => "https://transit.yahoo.co.jp/diainfo/94/0",
"西武山口線" => "https://transit.yahoo.co.jp/diainfo/95/0",
"東急東横線" => "https://transit.yahoo.co.jp/diainfo/112/0",
"東急目黒線" => "https://transit.yahoo.co.jp/diainfo/113/0",
"東急田園都市線" => "https://transit.yahoo.co.jp/diainfo/114/0",
"東急大井町線" => "https://transit.yahoo.co.jp/diainfo/115/0",
"東急多摩川線" => "https://transit.yahoo.co.jp/diainfo/116/0",
"東急池上線" => "https://transit.yahoo.co.jp/diainfo/117/0",
"東急世田谷線" => "https://transit.yahoo.co.jp/diainfo/119/0",
"東急こどもの国線" => "https://transit.yahoo.co.jp/diainfo/402/0",
"東急新横浜線" => "https://transit.yahoo.co.jp/diainfo/641/0",
"東京メトロ銀座線" => "https://transit.yahoo.co.jp/diainfo/132/0",
"東京メトロ丸ノ内線" => "https://transit.yahoo.co.jp/diainfo/133/0",
"東京メトロ日比谷線" => "https://transit.yahoo.co.jp/diainfo/134/0",
"東京メトロ東西線" => "https://transit.yahoo.co.jp/diainfo/135/0",
"東京メトロ千代田線" => "https://transit.yahoo.co.jp/diainfo/136/0",
"東京メトロ有楽町線" => "https://transit.yahoo.co.jp/diainfo/137/0",
"東京メトロ半蔵門線" => "https://transit.yahoo.co.jp/diainfo/138/0",
"東京メトロ南北線" => "https://transit.yahoo.co.jp/diainfo/139/0",
"東京メトロ副都心線" => "https://transit.yahoo.co.jp/diainfo/540/0",
"京成本線" => "https://transit.yahoo.co.jp/diainfo/96/0",
"京成東成田線" => "https://transit.yahoo.co.jp/diainfo/97/0",
"京成押上線" => "https://transit.yahoo.co.jp/diainfo/98/0",
"京成千葉線・千原線" => "https://transit.yahoo.co.jp/diainfo/99/0",
"京成金町線" => "https://transit.yahoo.co.jp/diainfo/101/0",
"京成松戸線" => "https://transit.yahoo.co.jp/diainfo/127/0",
"成田スカイアクセス線" => "https://transit.yahoo.co.jp/diainfo/622/0",
"京王新線" => "https://transit.yahoo.co.jp/diainfo/103/0",
"京王相模原線" => "https://transit.yahoo.co.jp/diainfo/104/0",
"京王高尾線" => "https://transit.yahoo.co.jp/diainfo/105/0",
"京王競馬場線" => "https://transit.yahoo.co.jp/diainfo/106/0",
"京王動物園線" => "https://transit.yahoo.co.jp/diainfo/107/0",
"京王井の頭線" => "https://transit.yahoo.co.jp/diainfo/108/0",
"都営浅草線" => "https://transit.yahoo.co.jp/diainfo/128/0",
"都営三田線" => "https://transit.yahoo.co.jp/diainfo/129/0",
"都営新宿線" => "https://transit.yahoo.co.jp/diainfo/130/0",
"都営大江戸線" => "https://transit.yahoo.co.jp/diainfo/131/0",
"都電荒川線" => "https://transit.yahoo.co.jp/diainfo/190/0",
"京急本線" => "https://transit.yahoo.co.jp/diainfo/120/0",
"京急空港線" => "https://transit.yahoo.co.jp/diainfo/121/0",
"京急大師線" => "https://transit.yahoo.co.jp/diainfo/122/0",
"京急逗子線" => "https://transit.yahoo.co.jp/diainfo/123/0",
"京急久里浜線" => "https://transit.yahoo.co.jp/diainfo/124/0",
"小田急江ノ島線" => "https://transit.yahoo.co.jp/diainfo/110/0",
"小田急多摩線" => "https://transit.yahoo.co.jp/diainfo/111/0",
"関東鉄道常総線" => "https://transit.yahoo.co.jp/diainfo/175/0",
"関東鉄道竜ケ崎線" => "https://transit.yahoo.co.jp/diainfo/176/0",
"相鉄線" => "https://transit.yahoo.co.jp/diainfo/125/0",
"北総線" => "https://transit.yahoo.co.jp/diainfo/141/0",
"東葉高速線" => "https://transit.yahoo.co.jp/diainfo/142/0",
"埼玉高速鉄道線" => "https://transit.yahoo.co.jp/diainfo/143/0",
"りんかい線" => "https://transit.yahoo.co.jp/diainfo/144/0",
"流鉄流山線" => "https://transit.yahoo.co.jp/diainfo/145/0",
"秩父鉄道線" => "https://transit.yahoo.co.jp/diainfo/146/0",
"箱根登山鉄道線" => "https://transit.yahoo.co.jp/diainfo/147/0",
"江ノ島電鉄線" => "https://transit.yahoo.co.jp/diainfo/148/0",
"小湊鉄道線" => "https://transit.yahoo.co.jp/diainfo/149/0",
"いすみ鉄道線" => "https://transit.yahoo.co.jp/diainfo/150/0",
"富士急行線" => "https://transit.yahoo.co.jp/diainfo/151/0",
"伊豆箱根鉄道大雄山線" => "https://transit.yahoo.co.jp/diainfo/153/0",
"東京モノレール線" => "https://transit.yahoo.co.jp/diainfo/154/0",
"湘南モノレール線" => "https://transit.yahoo.co.jp/diainfo/155/0",
"多摩都市モノレール線" => "https://transit.yahoo.co.jp/diainfo/156/0",
"千葉都市モノレール線" => "https://transit.yahoo.co.jp/diainfo/157/0",
"ゆりかもめ線" => "https://transit.yahoo.co.jp/diainfo/160/0",
"ひたちなか海浜鉄道湊線" => "https://transit.yahoo.co.jp/diainfo/177/0",
"上信電鉄線" => "https://transit.yahoo.co.jp/diainfo/179/0",
"上毛電鉄線" => "https://transit.yahoo.co.jp/diainfo/180/0",
"銚子電鉄線" => "https://transit.yahoo.co.jp/diainfo/181/0",
"伊豆急行線" => "https://transit.yahoo.co.jp/diainfo/182/0",
"野岩鉄道会津鬼怒川線" => "https://transit.yahoo.co.jp/diainfo/184/0",
"わたらせ渓谷鐵道線" => "https://transit.yahoo.co.jp/diainfo/185/0",
"鹿島臨海鉄道大洗鹿島線" => "https://transit.yahoo.co.jp/diainfo/186/0",
"真岡鐵道線" => "https://transit.yahoo.co.jp/diainfo/187/0",
"山万ユーカリが丘線" => "https://transit.yahoo.co.jp/diainfo/189/0",
"みなとみらい線" => "https://transit.yahoo.co.jp/diainfo/401/0",
"つくばエクスプレス線" => "https://transit.yahoo.co.jp/diainfo/412/0",
"芝山鉄道線" => "https://transit.yahoo.co.jp/diainfo/562/0",
"宇都宮ライトレール線" => "https://transit.yahoo.co.jp/diainfo/642/0",
"福井鉄道線" => "https://transit.yahoo.co.jp/diainfo/565/0",
"えちぜん鉄道三国芦原線" => "https://transit.yahoo.co.jp/diainfo/567/0",
"名鉄名古屋本線" => "https://transit.yahoo.co.jp/diainfo/208/0",
"近鉄名古屋線" => "https://transit.yahoo.co.jp/diainfo/230/0",
"名古屋市営東山線" => "https://transit.yahoo.co.jp/diainfo/240/0",
"名鉄西尾線" => "https://transit.yahoo.co.jp/diainfo/209/0",
"名鉄三河線" => "https://transit.yahoo.co.jp/diainfo/210/0",
"名鉄豊田線" => "https://transit.yahoo.co.jp/diainfo/211/0",
"名鉄蒲郡線" => "https://transit.yahoo.co.jp/diainfo/212/0",
"名鉄常滑線・空港線" => "https://transit.yahoo.co.jp/diainfo/213/0",
"名鉄築港線" => "https://transit.yahoo.co.jp/diainfo/214/0",
"名鉄河和線・知多新線" => "https://transit.yahoo.co.jp/diainfo/215/0",
"名鉄瀬戸線" => "https://transit.yahoo.co.jp/diainfo/217/0",
"名鉄小牧線" => "https://transit.yahoo.co.jp/diainfo/218/0",
"名鉄各務原線" => "https://transit.yahoo.co.jp/diainfo/219/0",
"名鉄犬山線" => "https://transit.yahoo.co.jp/diainfo/220/0",
"名鉄広見線" => "https://transit.yahoo.co.jp/diainfo/221/0",
"名鉄津島線・尾西線" => "https://transit.yahoo.co.jp/diainfo/222/0",
"名鉄竹鼻・羽島線" => "https://transit.yahoo.co.jp/diainfo/224/0",
"名鉄豊川線" => "https://transit.yahoo.co.jp/diainfo/226/0",
"御殿場線" => "https://transit.yahoo.co.jp/diainfo/195/0",
"身延線" => "https://transit.yahoo.co.jp/diainfo/196/0",
"飯田線" => "https://transit.yahoo.co.jp/diainfo/197/0",
"武豊線" => "https://transit.yahoo.co.jp/diainfo/199/0",
"高山本線" => "https://transit.yahoo.co.jp/diainfo/487/0",
"太多線" => "https://transit.yahoo.co.jp/diainfo/203/0",
"関西本線" => "https://transit.yahoo.co.jp/diainfo/278/0",
"紀勢本線" => "https://transit.yahoo.co.jp/diainfo/275/0",
"参宮線" => "https://transit.yahoo.co.jp/diainfo/206/0",
"名松線" => "https://transit.yahoo.co.jp/diainfo/207/0",
"小海線" => "https://transit.yahoo.co.jp/diainfo/471/0",
"篠ノ井線" => "https://transit.yahoo.co.jp/diainfo/472/0",
"大糸線" => "https://transit.yahoo.co.jp/diainfo/488/0",
"飯山線" => "https://transit.yahoo.co.jp/diainfo/476/0",
"越後線" => "https://transit.yahoo.co.jp/diainfo/477/0",
"弥彦線" => "https://transit.yahoo.co.jp/diainfo/478/0",
"北陸本線" => "https://transit.yahoo.co.jp/diainfo/481/0",
"九頭竜線" => "https://transit.yahoo.co.jp/diainfo/483/0",
"七尾線" => "https://transit.yahoo.co.jp/diainfo/484/0",
"氷見線" => "https://transit.yahoo.co.jp/diainfo/485/0",
"城端線" => "https://transit.yahoo.co.jp/diainfo/486/0",
"名古屋市営名城線・名港線" => "https://transit.yahoo.co.jp/diainfo/241/0",
"名古屋市営鶴舞線" => "https://transit.yahoo.co.jp/diainfo/242/0",
"名古屋市営桜通線" => "https://transit.yahoo.co.jp/diainfo/243/0",
"名古屋市営上飯田線" => "https://transit.yahoo.co.jp/diainfo/400/0",
"近鉄鈴鹿線" => "https://transit.yahoo.co.jp/diainfo/231/0",
"近鉄湯の山線" => "https://transit.yahoo.co.jp/diainfo/233/0",
"近鉄山田線・鳥羽線・志摩線" => "https://transit.yahoo.co.jp/diainfo/237/0",
"富山地方鉄道本線" => "https://transit.yahoo.co.jp/diainfo/571/0",
"富山地方鉄道立山線" => "https://transit.yahoo.co.jp/diainfo/572/0",
"富山地方鉄道不二越・上滝線" => "https://transit.yahoo.co.jp/diainfo/573/0",
"富山地方鉄道富山市内軌道線" => "https://transit.yahoo.co.jp/diainfo/574/0",
"大井川鉄道大井川本線" => "https://transit.yahoo.co.jp/diainfo/247/0",
"大井川鉄道井川線" => "https://transit.yahoo.co.jp/diainfo/248/0",
"豊橋鉄道渥美線" => "https://transit.yahoo.co.jp/diainfo/250/0",
"豊橋鉄道市内線" => "https://transit.yahoo.co.jp/diainfo/251/0",
"三岐鉄道三岐線" => "https://transit.yahoo.co.jp/diainfo/252/0",
"三岐鉄道北勢線" => "https://transit.yahoo.co.jp/diainfo/564/0",
"えちぜん鉄道勝山永平寺線" => "https://transit.yahoo.co.jp/diainfo/566/0",
"北陸鉄道石川線" => "https://transit.yahoo.co.jp/diainfo/568/0",
"北陸鉄道浅野川線" => "https://transit.yahoo.co.jp/diainfo/569/0",
"しなの鉄道線" => "https://transit.yahoo.co.jp/diainfo/580/0",
"しなの鉄道北しなの線" => "https://transit.yahoo.co.jp/diainfo/628/0",
"伊豆箱根鉄道駿豆線" => "https://transit.yahoo.co.jp/diainfo/244/0",
"岳南鉄道線" => "https://transit.yahoo.co.jp/diainfo/245/0",
"静岡鉄道線" => "https://transit.yahoo.co.jp/diainfo/246/0",
"遠州鉄道線" => "https://transit.yahoo.co.jp/diainfo/249/0",
"城北線" => "https://transit.yahoo.co.jp/diainfo/253/0",
"天竜浜名湖鉄道線" => "https://transit.yahoo.co.jp/diainfo/254/0",
"樽見鉄道線" => "https://transit.yahoo.co.jp/diainfo/256/0",
"明知鉄道線" => "https://transit.yahoo.co.jp/diainfo/257/0",
"長良川鉄道越美南線" => "https://transit.yahoo.co.jp/diainfo/258/0",
"愛知環状鉄道線" => "https://transit.yahoo.co.jp/diainfo/259/0",
"伊勢鉄道線" => "https://transit.yahoo.co.jp/diainfo/260/0",
"あおなみ線" => "https://transit.yahoo.co.jp/diainfo/548/0",
"養老鉄道線" => "https://transit.yahoo.co.jp/diainfo/563/0",
"のと鉄道線" => "https://transit.yahoo.co.jp/diainfo/570/0",
"万葉線" => "https://transit.yahoo.co.jp/diainfo/576/0",
"北越急行ほくほく線" => "https://transit.yahoo.co.jp/diainfo/577/0",
"長野電鉄線" => "https://transit.yahoo.co.jp/diainfo/578/0",
"上田電鉄別所線" => "https://transit.yahoo.co.jp/diainfo/581/0",
"アルピコ交通上高地線" => "https://transit.yahoo.co.jp/diainfo/582/0",
"あいの風とやま鉄道線" => "https://transit.yahoo.co.jp/diainfo/631/0",
"IRいしかわ鉄道線" => "https://transit.yahoo.co.jp/diainfo/632/0",
"四日市あすなろう鉄道線" => "https://transit.yahoo.co.jp/diainfo/635/0",
"ハピラインふくい線" => "https://transit.yahoo.co.jp/diainfo/643/0",
"大阪環状線" => "https://transit.yahoo.co.jp/diainfo/263/0",
"JR京都線" => "https://transit.yahoo.co.jp/diainfo/267/0",
"JR神戸線" => "https://transit.yahoo.co.jp/diainfo/273/0",
"阪急京都本線" => "https://transit.yahoo.co.jp/diainfo/306/0",
"大阪メトロ御堂筋線" => "https://transit.yahoo.co.jp/diainfo/321/0",
"JRゆめ咲線" => "https://transit.yahoo.co.jp/diainfo/264/0",
"JR宝塚線" => "https://transit.yahoo.co.jp/diainfo/265/0",
"琵琶湖線" => "https://transit.yahoo.co.jp/diainfo/266/0",
"湖西線" => "https://transit.yahoo.co.jp/diainfo/268/0",
"草津線" => "https://transit.yahoo.co.jp/diainfo/269/0",
"嵯峨野線" => "https://transit.yahoo.co.jp/diainfo/270/0",
"学研都市線" => "https://transit.yahoo.co.jp/diainfo/271/0",
"JR東西線" => "https://transit.yahoo.co.jp/diainfo/272/0",
"阪和線" => "https://transit.yahoo.co.jp/diainfo/274/0",
"羽衣線" => "https://transit.yahoo.co.jp/diainfo/276/0",
"大和路線" => "https://transit.yahoo.co.jp/diainfo/277/0",
"奈良線" => "https://transit.yahoo.co.jp/diainfo/279/0",
"桜井線" => "https://transit.yahoo.co.jp/diainfo/280/0",
"和歌山線" => "https://transit.yahoo.co.jp/diainfo/281/0",
"関西空港線" => "https://transit.yahoo.co.jp/diainfo/282/0",
"和田岬線" => "https://transit.yahoo.co.jp/diainfo/283/0",
"きのくに線" => "https://transit.yahoo.co.jp/diainfo/333/0",
"加古川線" => "https://transit.yahoo.co.jp/diainfo/334/0",
"播但線" => "https://transit.yahoo.co.jp/diainfo/336/0",
"舞鶴線" => "https://transit.yahoo.co.jp/diainfo/338/0",
"小浜線" => "https://transit.yahoo.co.jp/diainfo/489/0",
"福知山線" => "https://transit.yahoo.co.jp/diainfo/490/0",
"山陰本線" => "https://transit.yahoo.co.jp/diainfo/331/422",
"おおさか東線" => "https://transit.yahoo.co.jp/diainfo/584/0",
"近鉄大阪線" => "https://transit.yahoo.co.jp/diainfo/284/0",
"近鉄奈良線" => "https://transit.yahoo.co.jp/diainfo/285/0",
"近鉄けいはんな線" => "https://transit.yahoo.co.jp/diainfo/287/0",
"近鉄京都線" => "https://transit.yahoo.co.jp/diainfo/288/0",
"近鉄橿原線" => "https://transit.yahoo.co.jp/diainfo/289/0",
"近鉄天理線" => "https://transit.yahoo.co.jp/diainfo/290/0",
"近鉄信貴線" => "https://transit.yahoo.co.jp/diainfo/291/0",
"近鉄生駒線" => "https://transit.yahoo.co.jp/diainfo/292/0",
"近鉄田原本線" => "https://transit.yahoo.co.jp/diainfo/293/0",
"近鉄南大阪線" => "https://transit.yahoo.co.jp/diainfo/295/0",
"近鉄道明寺線" => "https://transit.yahoo.co.jp/diainfo/296/0",
"近鉄御所線" => "https://transit.yahoo.co.jp/diainfo/297/0",
"近鉄吉野線" => "https://transit.yahoo.co.jp/diainfo/298/0",
"近鉄長野線" => "https://transit.yahoo.co.jp/diainfo/299/0",
"阪急伊丹線" => "https://transit.yahoo.co.jp/diainfo/307/0",
"阪急今津線" => "https://transit.yahoo.co.jp/diainfo/308/0",
"阪急甲陽線" => "https://transit.yahoo.co.jp/diainfo/309/0",
"阪急神戸本線" => "https://transit.yahoo.co.jp/diainfo/310/0",
"阪急宝塚本線" => "https://transit.yahoo.co.jp/diainfo/311/0",
"阪急箕面線" => "https://transit.yahoo.co.jp/diainfo/312/0",
"阪急千里線" => "https://transit.yahoo.co.jp/diainfo/313/0",
"阪急嵐山線" => "https://transit.yahoo.co.jp/diainfo/314/0",
"大阪メトロ谷町線" => "https://transit.yahoo.co.jp/diainfo/322/0",
"大阪メトロ四つ橋線" => "https://transit.yahoo.co.jp/diainfo/323/0",
"大阪メトロ中央線" => "https://transit.yahoo.co.jp/diainfo/324/0",
"大阪メトロ千日前線" => "https://transit.yahoo.co.jp/diainfo/325/0",
"大阪メトロ堺筋線" => "https://transit.yahoo.co.jp/diainfo/326/0",
"大阪メトロ長堀鶴見緑地線" => "https://transit.yahoo.co.jp/diainfo/327/0",
"大阪メトロ今里筋線" => "https://transit.yahoo.co.jp/diainfo/537/0",
"南海本線" => "https://transit.yahoo.co.jp/diainfo/339/0",
"南海空港線" => "https://transit.yahoo.co.jp/diainfo/340/0",
"南海高師浜線" => "https://transit.yahoo.co.jp/diainfo/341/0",
"南海多奈川線" => "https://transit.yahoo.co.jp/diainfo/342/0",
"南海加太線" => "https://transit.yahoo.co.jp/diainfo/343/0",
"南海和歌山港線" => "https://transit.yahoo.co.jp/diainfo/344/0",
"南海高野線" => "https://transit.yahoo.co.jp/diainfo/346/0",
"南海汐見橋線" => "https://transit.yahoo.co.jp/diainfo/347/0",
"南海泉北線" => "https://transit.yahoo.co.jp/diainfo/348/0",
"京阪本線・中之島線" => "https://transit.yahoo.co.jp/diainfo/300/0",
"京阪交野線" => "https://transit.yahoo.co.jp/diainfo/301/0",
"京阪宇治線" => "https://transit.yahoo.co.jp/diainfo/302/0",
"京阪京津線" => "https://transit.yahoo.co.jp/diainfo/303/0",
"京阪石山坂本線" => "https://transit.yahoo.co.jp/diainfo/304/0",
"阪神本線" => "https://transit.yahoo.co.jp/diainfo/315/0",
"阪神なんば線" => "https://transit.yahoo.co.jp/diainfo/316/0",
"阪神武庫川線" => "https://transit.yahoo.co.jp/diainfo/317/0",
"神戸高速線" => "https://transit.yahoo.co.jp/diainfo/623/0",
"神戸電鉄有馬・三田線" => "https://transit.yahoo.co.jp/diainfo/350/0",
"神戸電鉄公園都市線" => "https://transit.yahoo.co.jp/diainfo/352/0",
"神戸電鉄粟生線" => "https://transit.yahoo.co.jp/diainfo/353/0",
"京都市営烏丸線" => "https://transit.yahoo.co.jp/diainfo/318/0",
"京都市営東西線" => "https://transit.yahoo.co.jp/diainfo/319/0",
"神戸市営西神・山手線・北神線" => "https://transit.yahoo.co.jp/diainfo/328/0",
"神戸市営海岸線" => "https://transit.yahoo.co.jp/diainfo/329/0",
"山陽電鉄本線" => "https://transit.yahoo.co.jp/diainfo/354/0",
"山陽電鉄網干線" => "https://transit.yahoo.co.jp/diainfo/355/0",
"京都丹後鉄道宮福線" => "https://transit.yahoo.co.jp/diainfo/374/0",
"京都丹後鉄道宮舞線・宮豊線" => "https://transit.yahoo.co.jp/diainfo/375/0",
"北大阪急行線" => "https://transit.yahoo.co.jp/diainfo/349/0",
"叡山電鉄線" => "https://transit.yahoo.co.jp/diainfo/360/0",
"阪堺電気軌道線" => "https://transit.yahoo.co.jp/diainfo/362/0",
"近江鉄道線" => "https://transit.yahoo.co.jp/diainfo/364/0",
"水間鉄道線" => "https://transit.yahoo.co.jp/diainfo/367/0",
"紀州鉄道線" => "https://transit.yahoo.co.jp/diainfo/369/0",
"能勢電鉄線" => "https://transit.yahoo.co.jp/diainfo/370/0",
"信楽高原鐵道線" => "https://transit.yahoo.co.jp/diainfo/376/0",
"北条鉄道線" => "https://transit.yahoo.co.jp/diainfo/377/0",
"大阪モノレール線" => "https://transit.yahoo.co.jp/diainfo/380/0",
"和歌山電鐵貴志川線" => "https://transit.yahoo.co.jp/diainfo/583/0",
"伊賀鉄道線" => "https://transit.yahoo.co.jp/diainfo/621/0",
"西鉄天神大牟田線" => "https://transit.yahoo.co.jp/diainfo/413/0",
"鹿児島本線" => "https://transit.yahoo.co.jp/diainfo/521/0",
"日豊本線" => "https://transit.yahoo.co.jp/diainfo/388/633",
"福北ゆたか線" => "https://transit.yahoo.co.jp/diainfo/389/0",
"原田線" => "https://transit.yahoo.co.jp/diainfo/390/0",
"若松線" => "https://transit.yahoo.co.jp/diainfo/391/0",
"香椎線" => "https://transit.yahoo.co.jp/diainfo/392/0",
"日田彦山線" => "https://transit.yahoo.co.jp/diainfo/394/0",
"後藤寺線" => "https://transit.yahoo.co.jp/diainfo/395/0",
"筑肥線" => "https://transit.yahoo.co.jp/diainfo/523/0",
"唐津線" => "https://transit.yahoo.co.jp/diainfo/524/0",
"長崎本線" => "https://transit.yahoo.co.jp/diainfo/525/0",
"佐世保線" => "https://transit.yahoo.co.jp/diainfo/526/0",
"大村線" => "https://transit.yahoo.co.jp/diainfo/527/0",
"久大本線" => "https://transit.yahoo.co.jp/diainfo/528/0",
"豊肥本線" => "https://transit.yahoo.co.jp/diainfo/529/0",
"三角線" => "https://transit.yahoo.co.jp/diainfo/530/0",
"肥薩線" => "https://transit.yahoo.co.jp/diainfo/531/0",
"吉都線" => "https://transit.yahoo.co.jp/diainfo/532/0",
"宮崎空港線" => "https://transit.yahoo.co.jp/diainfo/533/0",
"日南線" => "https://transit.yahoo.co.jp/diainfo/534/0",
"指宿枕崎線" => "https://transit.yahoo.co.jp/diainfo/535/0",
"山陽本線" => "https://transit.yahoo.co.jp/diainfo/332/419",
"西鉄太宰府線" => "https://transit.yahoo.co.jp/diainfo/414/0",
"西鉄甘木線" => "https://transit.yahoo.co.jp/diainfo/415/0",
"西鉄貝塚線" => "https://transit.yahoo.co.jp/diainfo/416/0",
"福岡市営空港線" => "https://transit.yahoo.co.jp/diainfo/397/0",
"福岡市営箱崎線" => "https://transit.yahoo.co.jp/diainfo/398/0",
"福岡市営七隈線" => "https://transit.yahoo.co.jp/diainfo/409/0",
"平成筑豊鉄道伊田線" => "https://transit.yahoo.co.jp/diainfo/607/0",
"平成筑豊鉄道田川線" => "https://transit.yahoo.co.jp/diainfo/608/0",
"平成筑豊鉄道糸田線" => "https://transit.yahoo.co.jp/diainfo/609/0",
"博多南線" => "https://transit.yahoo.co.jp/diainfo/396/0",
"北九州モノレール線" => "https://transit.yahoo.co.jp/diainfo/604/0",
"筑豊電鉄線" => "https://transit.yahoo.co.jp/diainfo/605/0",
"甘木鉄道線" => "https://transit.yahoo.co.jp/diainfo/606/0",
"松浦鉄道線" => "https://transit.yahoo.co.jp/diainfo/610/0",
"島原鉄道線" => "https://transit.yahoo.co.jp/diainfo/611/0",
"長崎電気軌道線" => "https://transit.yahoo.co.jp/diainfo/612/0",
"肥薩おれんじ鉄道線" => "https://transit.yahoo.co.jp/diainfo/613/0",
"南阿蘇鉄道線" => "https://transit.yahoo.co.jp/diainfo/614/0",
"くま川鉄道線" => "https://transit.yahoo.co.jp/diainfo/615/0",
"熊本電鉄線" => "https://transit.yahoo.co.jp/diainfo/617/0",
"赤穂線" => "https://transit.yahoo.co.jp/diainfo/330/0",
"姫新線" => "https://transit.yahoo.co.jp/diainfo/335/0",
"瀬戸大橋線" => "https://transit.yahoo.co.jp/diainfo/491/0",
"宇野線" => "https://transit.yahoo.co.jp/diainfo/492/0",
"津山線" => "https://transit.yahoo.co.jp/diainfo/493/0",
"因美線" => "https://transit.yahoo.co.jp/diainfo/494/0",
"吉備線" => "https://transit.yahoo.co.jp/diainfo/495/0",
"伯備線" => "https://transit.yahoo.co.jp/diainfo/496/0",
"境線" => "https://transit.yahoo.co.jp/diainfo/497/0",
"芸備線" => "https://transit.yahoo.co.jp/diainfo/498/0",
"福塩線" => "https://transit.yahoo.co.jp/diainfo/499/0",
"木次線" => "https://transit.yahoo.co.jp/diainfo/500/0",
"呉線" => "https://transit.yahoo.co.jp/diainfo/502/0",
"可部線" => "https://transit.yahoo.co.jp/diainfo/503/0",
"岩徳線" => "https://transit.yahoo.co.jp/diainfo/504/0",
"宇部線" => "https://transit.yahoo.co.jp/diainfo/505/0",
"小野田線" => "https://transit.yahoo.co.jp/diainfo/506/0",
"山口線" => "https://transit.yahoo.co.jp/diainfo/507/0",
"美祢線" => "https://transit.yahoo.co.jp/diainfo/508/0",
"広島電鉄宮島線" => "https://transit.yahoo.co.jp/diainfo/588/0",
"広島電鉄市内線" => "https://transit.yahoo.co.jp/diainfo/589/0",
"智頭急行線" => "https://transit.yahoo.co.jp/diainfo/379/0",
"岡山電気軌道線" => "https://transit.yahoo.co.jp/diainfo/585/0",
"水島臨海鉄道線" => "https://transit.yahoo.co.jp/diainfo/586/0",
"井原鉄道線" => "https://transit.yahoo.co.jp/diainfo/587/0",
"錦川鉄道線" => "https://transit.yahoo.co.jp/diainfo/591/0",
"若桜鉄道線" => "https://transit.yahoo.co.jp/diainfo/592/0",
"一畑電車線" => "https://transit.yahoo.co.jp/diainfo/593/0"
}

redis = Redis.new(url: ENV['REDIS_URL'])

def client
  @client ||= Line::Bot::Client.new do |config|
    config.channel_secret = ENV['LINE_CHANNEL_SECRET']
    config.channel_token = ENV['LINE_CHANNEL_TOKEN']
  end
end

def fetch_status(url)
  uri = URI.parse(url)
  response = Net::HTTP.get(uri)
  doc = Nokogiri::HTML(response)
  status = doc.at_css('#mdServiceStatus dt')&.text&.strip || "不明"
  detail = doc.at_css('#mdServiceStatus dd')&.text&.strip || "詳細情報なし"
  [status, detail]
end

def fetch_weather(city = "Tokyo")
  api_key = ENV['OPENWEATHER_API_KEY']
  uri = URI("https://api.openweathermap.org/data/2.5/weather?q=#{city}&appid=#{api_key}&units=metric&lang=ja")
  res = Net::HTTP.get(uri)
  data = JSON.parse(res)
  "天気: #{data['weather'][0]['description']}, 気温: #{data['main']['temp']}℃"
end

# 遅延まとめ
delay_message = LINES.map do |name, url|
  status, detail = fetch_status(url)
  status !~ /平常運転/ ? "【#{name}】\n状況: #{status}\n詳細: #{detail}" : nil
end.compact.join("\n\n")
delay_message = delay_message.empty? ? "現在、遅延情報はありません。" : "【遅延まとめ】\n" + delay_message

# TOP5
top5 = redis.keys("count:*").map { |k| [k.split(":")[1], redis.get(k).to_i] }.sort_by { |_, v| -v }.first(5)
top5_message = top5.empty? ? "データなし" : top5.map.with_index(1) { |(line, count), i| "#{i}. #{line} (#{count}回)" }.join("\n")

weather = fetch_weather

final_message = <<~MSG
【朝の運行情報まとめ】
#{delay_message}

【人気路線TOP5】
#{top5_message}

【東京の天気】
#{weather}
MSG

client.push_message(ENV['LINE_USER_ID'], { type: 'text', text: final_message })
